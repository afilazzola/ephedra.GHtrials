---
title: 'Cost of facilitation: invasive grasses limit recruitment of benefactor shrubs.'
author: "afilazzola & cjlortie"
date: "September 2017"
output:
  html_document:
    theme: yeti
    toc: yes
    toc_float: yes
    toc_depth: 3
  
---

![](ephedra.jpg)

[ecoblender](http://ecoblender.org)

[alex.filazzola](http://www.filazzola.info)

#### Abstract

Shrubs facilitate the abundance and productive of annual plants in desert ecosystems.However, these shrub microhabitats favour plant species with competitive life histories. Ephedra californica is a dominant shrub in the San Joaquin desert that has been identified as a facilitator. Here, we explore the factors that limit the Ephedra californica recruitment into the San Joaquin desert including substrate, water availability, and herbivory. We also explore the role of the invasive grass Bromus madritensis on limiting establishment of E. californica. Vegetation surveys were conducted in the field during 2013 and collected seed was then used to conduct two greenhouse trials. The first explore germination and establishment techniques for E. california and the optimal substrate. The second examined E. californica establishment in present of the invasive B. madritensis responding to different water levels and herbivory. These results can have implications for land managers in the San Joaquin Valley to maintain native shrub biodiversity in the region. 



---
```{r data & library input, warning=FALSE, message=FALSE}

## load libraries
library(tidyverse)
library(OIsurv)
library(lsmeans)

## load data
substrate <-read.csv("data/ephedra.substrate.csv")
recruit <-read.csv("data/ephedra.recruitment.csv")
landscape <-read.csv("data/ephedra.landscape.csv")

##load functions
## inverse hyperbolic sine transformation 
ihs <- function(x) {
    y <- log(x + sqrt(x ^ 2 + 1))
    return(y)
}
se <- function(x, ...) sqrt(var(na.omit(x))/length(na.omit(x)))

```


### Ephedra recruitment at landscape
```{r}
## compare ephedra size and density across landscape
landscape[,"area.group"] <- as.numeric(cut(landscape$Log.area,20))
hist(landscape$area.group)

mean.area <- landscape %>% group_by(area.group) %>%  summarize(rdm=mean(RDM.2013), area=mean(Log.area), density=mean(Shrub.density))

ggplot(mean.area) + geom_point(aes(x=density, y=area), size=3)+ylab("log (area of shrub)")+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),axis.line = element_line(colour = "black"),panel.background = element_blank(),axis.text=element_text(size=14),axis.title=element_text(size=16)) + xlab(expression("shrub density (m"^"2"*")")) +  stat_smooth(method="lm", formula= y~x,aes(x=density, y=area))

m1 <- lm(area~density, data=mean.area)
summary(m1)

ggplot(mean.area) + geom_point(aes(x=density, y=rdm), size=mean.area$area+1)+ylab("residual dry matter")+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),axis.line = element_line(colour = "black"),panel.background = element_blank(),axis.text=element_text(size=14),axis.title=element_text(size=16)) + xlab(expression("shrub density (m"^"2"*")")) +  stat_smooth(method="lm", formula= y~x,aes(x=density, y=rdm))


m2 <- lm(rdm~density, data=mean.area)
summary(m2)
```

### Ephedra optimal substrate
```{r, fig.height=8, fig.width=10}
substrate[,"Sand"] <- as.factor(substrate$Sand)
substrate[,"census"] <- as.factor(substrate$census)

m1 <- aov(height ~ Micro * Sand,  data=subset(substrate, census==10))
summary(m2) ## nothing significant


## compare shade on survival of ephedra
my.surv <- Surv(as.numeric(substrate$census), substrate$survival)
fit1 <- survfit(my.surv~Micro, data=substrate)
summary(fit1)


par(mar=c(4.5,4.5,.5,.5))
plot(fit1, col="white", ylim=c(0.2,1), xlim=c(0.9,10.1), ylab="Estimated Survival Function", xlab="Census", cex.lab=1.5, cex.axis=1.3)
lines(1:10,summary(fit1)[[10]][1:10], col="#E69F00", lty=2) ## upper
lines(1:10,summary(fit1)[[6]][1:10], col="#E69F00", lwd=2) ## value sun
lines(1:10,summary(fit1)[[11]][1:10], col="#E69F00", lty=2) ## lower
lines(1:10,summary(fit1)[[10]][11:20], col="#56B4E9", lty=2) ## upper
lines(1:10,summary(fit1)[[6]][11:20], col="#56B4E9", lwd=2) ## value shade
lines(1:10,summary(fit1)[[11]][11:20], col="#56B4E9", lty=2) ## lower
legend(1.8, 0.35, c("Sun","Shade"), lty=1, lwd=3, col=c("#E69F00","#56B4E9"), cex=1.5)

coxph.fit <- coxph(my.surv ~ Micro, method="breslow", data=substrate)
coxph.fit 


## compare sand on survival of ephedra
my.surv <- Surv(as.numeric(substrate$census), substrate$survival)
fit2 <- survfit(my.surv~Sand, data=substrate)
summary(fit2)


test <- substrate %>% group_by(census,Sand) %>%  summarize(count=sum(survival),avg=mean(survival))
test <- data.frame(test)

par(mar=c(4.5,4.5,.5,.5))
plot(fit2, col="white", ylim=c(0.2,1), xlim=c(0.9,10.1), ylab="Estimated Survival Function", xlab="Census", cex.lab=1.5, cex.axis=1.3)
lines(1:10,summary(fit2)[[10]][1:10], col="#E69F00", lty=2) ## upper
lines(1:10,summary(fit2)[[6]][1:10], col="#E69F00", lwd=2) ## value sand 0
lines(1:10,summary(fit2)[[11]][1:10], col="#E69F00", lty=2) ## lower
lines(1:10,summary(fit2)[[10]][11:20], col="#56B4E9", lty=2) ## upper
lines(1:10,summary(fit2)[[6]][11:20], col="#56B4E9", lwd=2) ## value sand 25
lines(1:10,summary(fit2)[[11]][11:20], col="#56B4E9", lty=2) ## lower
lines(1:10,summary(fit2)[[10]][21:30], col="#009E73", lty=2) ## upper
lines(1:10,summary(fit2)[[6]][21:30], col="#009E73", lwd=2) ## value sand 50
lines(1:10,summary(fit2)[[11]][21:30], col="#009E73", lty=2) ## lower
lines(1:10,summary(fit2)[[10]][31:40], col="#CC79A7", lty=2) ## upper
lines(1:10,summary(fit2)[[6]][31:40], col="#CC79A7", lwd=2) ## value sand 75
lines(1:10,summary(fit2)[[11]][31:40], col="#CC79A7", lty=2) ## lower
lines(1:10,summary(fit2)[[10]][41:50], col="#D55E00", lty=2) ## upper
lines(1:10,summary(fit2)[[6]][41:50], col="#D55E00", lwd=2) ## value sand 100
lines(1:10,summary(fit2)[[11]][41:50], col="#D55E00", lty=2) ## lower
legend(1.7, 0.44, c("0%","25%","50%","75%","100%"), lty=1, lwd=3, col=c("#E69F00","#56B4E9","#009E73","#CC79A7","#D55E00"), cex=1.2, title="Sand")

coxph.fit <- coxph(my.surv ~ Sand, method="breslow", data=substrate)
coxph.fit 

## raw number of germinants end trials

end <- subset(substrate, census==10)

## compare microsite

end.means <- end %>% group_by(Micro) %>% summarize(eph=mean(survival), eph.se=se(survival), Height=mean(height, na.rm=T), Height.se=se(height)) %>% gather(measure, value, 2:5) %>% separate(measure, c("Eph",".se")) ## calculate metrics and put long format
end.means[is.na(end.means$.se),3] <- "mean"
end.means <- end.means %>% spread(.se, value)
end.means <- data.frame(end.means)

end.means[,"lower"] <- end.means[,"mean"]-end.means[,"se"]
end.means[,"upper"] <- end.means[,"mean"]+end.means[,"se"]

survival <- subset(end.means, Eph=="eph")

plot1 <- ggplot(survival, aes(x=Micro, y=mean)) + geom_bar(stat="identity") +
  geom_errorbar(aes(ymin=lower, ymax=upper), width=.2)+ylab("average surviving Ephedra plant")+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),axis.line = element_line(colour = "black"),panel.background = element_blank(),axis.text=element_text(size=14),axis.title=element_text(size=16)) + xlab("Microsite") 

height <- subset(end.means, Eph=="Height")

plot2 <- ggplot(height, aes(x=Micro, y=mean)) + geom_bar(stat="identity") +
  geom_errorbar(aes(ymin=lower, ymax=upper), width=.2)+ylab("average height of Ephedra plant")+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),axis.line = element_line(colour = "black"),panel.background = element_blank(),axis.text=element_text(size=14),axis.title=element_text(size=16)) + xlab("Microsite") 

require(gridExtra)

grid.arrange(plot1, plot2, ncol=2)
m1 <- glm(survival~ Sand* Micro, data=end, family="binomial")
anova(m1, test="Chisq")

lsmeans(m1, pairwise~Sand)


## survival
end.means <- end %>% group_by(Sand) %>% summarize(eph=mean(survival), eph.se=se(survival))
end.means <- data.frame(end.means)

end.means[,"lower"] <- end.means[,"eph"]-end.means[,"eph.se"]
end.means[,"upper"] <- end.means[,"eph"]+end.means[,"eph.se"]

ggplot(end.means, aes(x=Sand, y=eph)) + geom_bar(stat="identity", fill="#56B4E9") +
  geom_errorbar(aes(ymin=lower, ymax=upper), width=.2)+ylab("average surviving Ephedra plant")+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),axis.line = element_line(colour = "black"),panel.background = element_blank(),axis.text=element_text(size=14),axis.title=element_text(size=16)) + xlab("Percentage of sand in soil") 


## height

end.means <- end %>% group_by(Sand) %>% summarize(eph=mean(height, na.rm=T), eph.se=se(height, na.rm=T))
end.means <- data.frame(end.means)

end.means[,"lower"] <- end.means[,"eph"]-end.means[,"eph.se"]
end.means[,"upper"] <- end.means[,"eph"]+end.means[,"eph.se"]

ggplot(end.means, aes(x=Sand, y=eph)) + geom_bar(stat="identity", fill="#56B4E9") +
  geom_errorbar(aes(ymin=lower, ymax=upper), width=.2)+ylab("average surviving Ephedra plant")+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),axis.line = element_line(colour = "black"),panel.background = element_blank(),axis.text=element_text(size=14),axis.title=element_text(size=16)) + xlab("Percentage of sand in soil") 


## most germinants
maximum.germ <- substrate %>% group_by(Micro, Sand, Rep) %>% summarize(eph.max=max(survival))

max.eph <- maximum.germ %>% group_by(Sand) %>% summarize(eph=mean(eph.max,na.rm=T),eph.se=se(eph.max, na.rm=T)) 
max.eph <- data.frame(max.eph)

max.eph[,"lower"] <- max.eph[,"eph"]-max.eph[,"eph.se"]
max.eph[,"upper"] <- max.eph[,"eph"]+max.eph[,"eph.se"]


ggplot(max.eph, aes(x=Sand, y=eph)) + geom_point(fill="black", size=4) +
  geom_errorbar(aes(ymin=lower, ymax=upper), width=.2)+ylab("total Ephedra germinants")+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),axis.line = element_line(colour = "black"),panel.background = element_blank(),axis.text=element_text(size=14),axis.title=element_text(size=16)) + xlab("Percentage of sand in soil") + ylim(0,1) + stat_smooth(method="lm", formula= y~poly(x,2),data=max.eph, aes(x=as.numeric(Sand), y=eph), lwd=1, color="black", lty=2)


m1 <- lm(eph~poly(as.numeric(Sand),2), data=max.eph)
summary(m1)
```

### Test of limiting factors - water
```{r}
recruit[is.na(recruit)] <- 0

m1 <- glm(ephedra.end ~ brome.begin, data=recruit, family=binomial)

## water
water <- subset(recruit, Treatment == "control" | Treatment=="water")


## most germinants
water.mean <- water %>% group_by(Density, Lvl) %>% summarize(eph=mean(ephedra.end),brome=mean(brome.begin))

ggplot(water.mean) + geom_point(aes(x=Density, y=eph, fill=Lvl, color=Lvl))
